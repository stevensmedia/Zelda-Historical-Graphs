<html>
<head>
<link rel="stylesheet" href="https://raw.githubusercontent.com/palantir/plottable/master/plottable.css" charset="utf-8"></link>
<script type="text/javascript" src="http://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="https://raw.githubusercontent.com/palantir/plottable/master/plottable.min.js"></script>
<style type="text/css">
	.timeline {
		width: 100%;
		height: 800px;
	}

	.plotpopup {
		position: absolute;
		width: 300px;
		height: 48px;
		margin-left: -200px;
		margin-top: 25px;
		font-family: Joystix, Mono;
		font-size: 10px;
		display: none;
		border: solid 1px #777777;
		background: rgba(100,100,100, .5);
		color: #ffffff;
		text-align: center;
	}
</style>
<script type="text/javascript">
	var todayJS = new Date();

	var z2Data = [
		{ name: 'Scott "sdkess" Kessler',             time: '72:10', begin: new Date(2004, 7, 25) },
		{ name: 'Kristian "Arctic_Eagle" Emanuelsen', time: '70:26', begin: new Date(2006, 11, 27) },
		{ name: 'Kristian "Arctic_Eagle" Emanuelsen', time: '66:17', begin: new Date(2007, 1, 15) },
		{ name: 'Kristian "Arctic_Eagle" Emanuelsen', time: '65:00', begin: new Date(2008, 3, 3) },
		{ name: 'Kristian "Arctic_Eagle" Emanuelsen', time: '59:41', begin: new Date(2009, 5, 2) },
		{ name: 'Kristian "Arctic_Eagle" Emanuelsen', time: '57:43', begin: new Date(2011, 0, 2) },
		{ name: 'Jeff Feasel',                        time: '34:21', begin: new Date(2012, 8, 26) },
		{ name: 'Jeff Feasel',                        time: '28:35', begin: new Date(2012, 9, 2) },
		{ name: 'Neil "PresJPolk" Stevens',           time: '28:14', begin: new Date(2013, 1, 9) },
		{ name: 'John "Pro_JN" Nurminen',             time: '27:04', begin: new Date(2013, 1, 10) },
		{ name: 'Neil "PresJPolk" Stevens',           time: '26:30', begin: new Date(2013, 1, 11) },
		{ name: 'John "Pro_JN" Nurminen',             time: '22:33', begin: new Date(2013, 1, 12) },
		{ name: 'Neil "PresJPolk" Stevens',           time: '21:51', begin: new Date(2013, 4, 12) },
		{ name: 'John "Pro_JN" Nurminen',             time: '20:42', begin: new Date(2013, 4, 15) },
		{ name: 'John "Pro_JN" Nurminen',             time: '19:53', begin: new Date(2013, 5, 19) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '19:47', begin: new Date(2013, 5, 21) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '19:26', begin: new Date(2013, 5, 23) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '19:21', begin: new Date(2013, 9, 17) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '19:15', begin: new Date(2013, 9, 20) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '19:05', begin: new Date(2014, 3, 15) },
		{ name: 'John "Pro_JN" Nurminen',             time: '18:53', begin: new Date(2014, 5, 19) },
		{ name: 'Ian "Opus" Napierkowski',            time: '18:35', begin: new Date(2015, 9, 1) },
		{ name: 'Ian "Opus" Napierkowski',            time: '18:31', begin: new Date(2016, 3, 22) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '18:29', begin: new Date(2017, 1, 1) },
		{ name: 'Ian "Opus" Napierkowski',            time: '18:25', begin: new Date(2017, 1, 1) },
		{ name: 'Lloyd "Simpoldood" M.',              time: '18:23', begin: new Date(2017, 1, 5) },
		{ name: 'Ian "Opus" Napierkowski',            time: '18:18', begin: new Date(2017, 1, 5) },
		{ name: 'Ian "Opus" Napierkowski',            time: '18:12', begin: new Date(2017, 1, 5) },
		{ name: 'Ian "Opus" Napierkowski',            time: '18:07', begin: new Date(2017, 1, 19) },
	];

	var lozData = [
		{begin: new Date(2003, 7, 01), name: 'Rdrunner', time: '34:04'},
		{begin: new Date(2012, 4, 30), name: 'hal_yotsuba (はる＠よつば)', time: '33:14'},
		{begin: new Date(2012, 6, 5), name: 'Darkwing Duck', time: '32:52'},
		{begin: new Date(2012, 6, 16), name: 'Darkwing Duck', time: '32:46'},
		{begin: new Date(2012, 6, 26), name: 'Darkwing Duck', time: '32:45'},
		{begin: new Date(2012, 7, 1), name: 'Darkwing Duck', time: '32:31'},
		{begin: new Date(2012, 7, 5), name: 'Darkwing Duck', time: '32:20'},
		{begin: new Date(2012, 7, 11), name: 'Darkwing Duck', time: '32:04'},
		{begin: new Date(2013, 2, 3), name: 'hal_yotsuba (はる＠よつば)', time: '31:35'},
		{begin: new Date(2013, 8, 24), name: 'Darkwing Duck', time: '31:25'},
		{begin: new Date(2014, 5, 20), name: 'Darkwing Duck', time: '31:07'},
		{begin: new Date(2014, 7, 9), name: 'LackAttack24', time: '31:02'},
		{begin: new Date(2014, 8, 30), name: 'Darkwing Duck', time: '30:37'},
		{begin: new Date(2015, 1, 23), name: 'Darkwing Duck', time: '30:29'},
		{begin: new Date(2015, 2, 7), name: 'LackAttack24', time: '30:25'},
		{begin: new Date(2015, 2, 10), name: 'Darkwing Duck', time: '30:16'},
		{begin: new Date(2015, 2, 27), name: 'LackAttack24', time: '30:06'},
		{begin: new Date(2015, 3, 31), name: 'LackAttack24', time: '29:56'},
		{begin: new Date(2015, 8, 21), name: 'LackAttack24', time: '29:50'},
		{begin: new Date(2015, 9, 15), name: 'LackAttack24', time: '29:48'},
		{begin: new Date(2015, 9, 21), name: 'LackAttack24', time: '29:36'},
		{begin: new Date(2015, 9, 29), name: 'LackAttack24', time: '29:33'},
		{begin: new Date(2015, 10, 19), name: 'LackAttack24', time: '29:24'},
		{begin: new Date(2015, 10, 30), name: 'LackAttack24', time: '29:19'},
		{begin: new Date(2015, 11, 19), name: 'LackAttack24', time: '29:13'},
		{begin: new Date(2015, 11, 21), name: 'LackAttack24', time: '29:11'},
		{begin: new Date(2015, 12, 2), name: 'LackAttack24', time: '29:04'},
		{begin: new Date(2015, 12, 9), name: 'LackAttack24', time: '28:50'},
		{begin: new Date(2016, 6, 26), name: 'Eunos', time: '28:42'},
		{begin: new Date(2016, 10, 26), name: 'Eunos', time: '28:40'},
		{begin: new Date(2016, 11, 2), name: 'Eunos', time: '28:35'},
		{begin: new Date(2017, 2, 13), name: 'LackAttack24', time: '28:19'},
		{begin: new Date(2017, 2, 21), name: 'Eunos', time: '28:12'},
		{begin: new Date(2017, 3, 3), name: 'Eunos', time: '28:08'},
		{begin: new Date(2017, 3, 8), name: 'Eunos', time: '28:03'},
		{begin: new Date(2017, 4, 8), name: 'Eunos', time: '28:02'},
	];

	function setEnds(ary) {
		ary[ary.length - 1]['end'] = new Date();
		for(var i = ary.length - 2; i >= 0; --i) {
			ary[i]['end'] = ary[i + 1].begin
		}
	}
	setEnds(lozData);
	setEnds(z2Data);

	function getPlayerNames(data) {
		var ret = [];
		data.forEach(function(row) {
			if(-1 == ret.indexOf(row.name)) {
				ret.push(row.name);
			}
		});
		return ret;
	}

	function convertTime(s) {
		var c = s.split(':');
		var secs = c[0] * 60 + c[1] * 1;
		return secs;
	}

	function printSecs(secs) {
		return Math.floor(secs / 60) + ":" + secs % 60;
	}

	function drawChart(data, selector) {
		var playerNames = getPlayerNames(data);
		var colorScale = new Plottable.Scales.Color();

		var xScale = new Plottable.Scales.Time();
		var xAxisTop = new Plottable.Axes.Time(xScale, "top");
		var xAxisBottom = new Plottable.Axes.Time(xScale, "bottom");

		var yScalePlayer = new Plottable.Scales.Category();
		var yAxisPlayer = new Plottable.Axes.Category(yScalePlayer, "left");

		var plotPlayer = new Plottable.Plots.Rectangle()
		  .x(           function(d) { return d.begin; }, xScale)
		  .x2(          function(d) { return d.end;   })
		  .y(           function(d) { return d.name;  }, yScalePlayer)
		  .attr("fill", function(d) { return playerNames.indexOf(d.name);  }, colorScale)
		  .addDataset(new Plottable.Dataset(data));

		var xScale = new Plottable.Scales.Time();
		var xAxis = new Plottable.Axes.Time(xScale, "bottom");

		var yScaleTime = new Plottable.Scales.Linear();
		var yAxisTime = new Plottable.Axes.Numeric(yScaleTime, "left");
		yAxisTime.formatter(printSecs);

		var plotTime = new Plottable.Plots.Line()
		  .x(           function(d) { return d.begin;              }, xScale)
		  .y(           function(d) { return convertTime(d.time);  }, yScaleTime)
		  .attr("stroke", function(d) { return "#000000"; } )
		  .interpolator("step-after")
		  .addDataset(new Plottable.Dataset(data));

		var popupInterval;
		var popupLast;
		var popup = jQuery('.plotpopup');
		function clearHighlight() {
			plotPlayer.entities().forEach(function(entity) {
				jQuery(entity.selection[0][0]).attr('stroke', 'rgba(0, 0, 0, 0)');
			});
		}
		function generateHighlighter(plot) {
			var highlight = new Plottable.Interactions.Pointer();
			highlight.onPointerMove(function(point) {
				var entities = plotPlayer.entitiesIn({min: point.x, max: point.x}, {min: -9999999, max: 9999999});
				clearHighlight();
				if(entities.length && popupLast != entities[0]) {
					var entity = entities[0];
					popupLast = entity;
					var rect = jQuery(entities[0].selection[0][0]);
					rect.attr('stroke', 'rgba(0, 0, 0, 1.0)')
					    .attr('stroke-width', '2px');

					var html = "Runner: " + entity.datum.name + "<br/>" +
					           "Time: " + entity.datum.time + "<br/>" +
					           "Date: " + entity.datum.begin.toLocaleDateString();
					popup.css("left", getMouse().x)
					     .css("top", getMouse().y)
					     .css("display", 'block')
					     .html(html);

					jQuery('body').append(popup);

					if(popupInterval) {
						clearInterval(popupInterval);
						popupInterval = null;
					}
				}
			});
			highlight.onPointerExit(function() {
				popupInterval = setInterval(function() {
					popup.css('display', 'none');
					clearHighlight();
				}, 500);
			});
			highlight.attachTo(plot);
		}

		generateHighlighter(plotTime);
		generateHighlighter(plotPlayer);

		var chart = new Plottable.Components.Table([
			[null,        xAxisTop   ],
			[yAxisPlayer, plotPlayer ],
			[yAxisTime,   plotTime   ],
			[null,        xAxisBottom]
		]);
		chart.rowWeight(1, 1);
		chart.rowWeight(2, 2);

		chart.renderTo(selector);
	}

	var getMouse;
	function setMouseEvent() {
		var currentMousePos = { x: -1, y: -1 };
		$(document).mousemove(function(event) {
			currentMousePos.x = event.pageX;
			currentMousePos.y = event.pageY;
		});
		getMouse = function() {
			return currentMousePos;
		}
	}

	jQuery(document).ready(function() {
		drawChart(lozData, "#loztimeline");
		drawChart(z2Data, "#z2timeline");
		setMouseEvent();
	});


</script>
</head>
<body>
<svg class="timeline" id="loztimeline"></svg>
<svg class="timeline" id="z2timeline"></svg>
<div class="plotpopup");
<p>Important note<p>
<p>The reason the time dropped like a rock from Arctic_Eagle's time wasn't that his runs were bad.  In fact they were very good.  It's that Solairflaire found the Thunderbird skip, and that completely changed the possible routing.  In addition, the glitched hammer and Palace 7 were routed in.</p>
</body>
</html>
